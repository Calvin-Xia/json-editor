# JSON/JSON5 编辑器 PRD（产品需求文档）

> 版本：v1.0  
> 日期：2026-02-18  
> 状态：待评审

---

## 一、产品概述

### 1.1 产品定位
Windows 本地离线 GUI 工具，用于可视化编辑 JSON/JSON5 文件，支持无损读写、结构导航、差异预览和版本管理。开源到 GitHub，面向开发者、运维、数据工程师等需要频繁编辑配置文件的用户。

### 1.2 核心价值
- **无损编辑**：保留 JSON5 特性（注释、尾逗号、引号风格等）
- **可视化操作**：树形导航 + 动态表单，降低编辑复杂结构的心智负担
- **安全可靠**：差异预览、撤销重做、自动保存、版本回滚

---

## 二、用户流程与页面结构

### 2.1 核心用户流程

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                              用户主流程                                      │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                             │
│   ┌──────────┐    ┌──────────┐    ┌──────────┐    ┌──────────┐            │
│   │  打开文件  │───▶│  结构解析  │───▶│  可视化编辑 │───▶│  预览差异  │            │
│   └──────────┘    └──────────┘    └──────────┘    └──────────┘            │
│        │                                                  │                │
│        │              ┌──────────────────────────────────┘                │
│        │              ▼                                                   │
│        │         ┌──────────┐                                            │
│        │         │  满意？   │                                            │
│        │         └──────────┘                                            │
│        │           /      \                                              │
│        │        否/        \是                                           │
│        │         ▼          ▼                                            │
│        │   ┌──────────┐  ┌──────────┐                                    │
│        │   │  继续编辑  │  │ 保存/另存为│                                    │
│        │   └──────────┘  └──────────┘                                    │
│        │                     │                                           │
│        ▼                     ▼                                           │
│   ┌──────────┐         ┌──────────┐                                      │
│   │ 拖拽打开  │         │ 覆盖原文件 │                                      │
│   │ 文件对话框│         │ 或另存为新 │                                      │
│   │ 剪贴板粘贴│         └──────────┘                                      │
│   └──────────┘                                                           │
│                                                                             │
└─────────────────────────────────────────────────────────────────────────────┘
```

### 2.2 页面结构

#### 主界面布局

```
┌─────────────────────────────────────────────────────────────────────────────┐
│ 文件(F)  编辑(E)  视图(V)  工具(T)  帮助(H)                    [最小化][最大化][关闭] │
├─────────────────────────────────────────────────────────────────────────────┤
│ 工具栏: [打开] [保存] [撤销] [重做] [搜索] [导出] [版本历史]                     │
├───────────────────────┬─────────────────────────────────────────────────────┤
│                       │                                                     │
│   📁 树形导航          │              动态表单编辑区                           │
│   ├─ 📂 root          │  ┌─────────────────────────────────────────────────┐│
│   │  ├─ 📂 config     │  │ 当前路径: root.config                           ││
│   │  │  ├─ 🔑 name    │  ├─────────────────────────────────────────────────┤│
│   │  │  ├─ 🔑 version │  │                                                 ││
│   │  │  └─ 📂 servers │  │  字段名        类型        值                     ││
│   │  │     ├─ 📋 [0]  │  │ ┌─────────────────────────────────────────────┐││
│   │  │     │  └─ 🔑 host│  │ │ name      [string]  [________________]    │││
│   │  │     └─ 📋 [1]  │  │ │ version  [string]  [________________]    │││
│   │  └─ 🔑 debug      │  │ │ debug    [boolean] [✓]                    │││
│   │                    │  │ │ servers  [array]   [展开/折叠]            │││
│   │  [🔍 搜索字段...]   │  │ │ [+ 添加字段]                                │││
│   │                    │  │ └─────────────────────────────────────────────┘││
│   │                    │  │                                                 ││
│   │                    │  │  [验证状态: ✅ 无错误]                           ││
│   │                    │  └─────────────────────────────────────────────────┘│
│   │                    │                                                     │
├───────────────────────┴─────────────────────────────────────────────────────┤
│ 状态栏: 文件: config.json5 | 编码: UTF-8 | 大小: 2.3KB | 最后保存: 10:30:00   │
└─────────────────────────────────────────────────────────────────────────────┘
```

#### 差异预览弹窗

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                        差异预览                                    [×]       │
├─────────────────────────────────────────────────────────────────────────────┤
│ [路径变更列表] [文本Diff]                                                    │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                             │
│  变更路径                                    操作        旧值 → 新值         │
│  ─────────────────────────────────────────────────────────────────────────  │
│  root.config.name                           修改        "app" → "myapp"    │
│  root.config.servers[0].port                新增        8080               │
│  root.config.debug                          删除        true               │
│  root.config.servers[1]                     移动        [1] → [0]          │
│                                                                             │
├─────────────────────────────────────────────────────────────────────────────┤
│                                              [取消]  [确认保存]             │
└─────────────────────────────────────────────────────────────────────────────┘
```

### 2.3 详细页面说明

| 页面/组件 | 功能描述 | 交互要点 |
|-----------|----------|----------|
| 主窗口 | 核心编辑界面 | 左右分栏，可拖拽调整比例 |
| 树形导航 | 展示 JSON 结构 | 支持展开/折叠、右键菜单、拖拽排序 |
| 动态表单 | 编辑选中节点 | 根据类型动态渲染控件 |
| 差异预览 | 保存前确认 | 必须展示，不可跳过 |
| 版本历史 | 版本管理 | 时间线列表，支持预览和回滚 |
| 搜索面板 | 字段搜索 | 支持正则、路径匹配 |

---

## 三、功能需求分级

### 3.1 MVP（必须有）

| 编号 | 功能 | 描述 | 优先级 |
|------|------|------|--------|
| M1 | 文件打开 | 支持文件对话框、拖拽打开、剪贴板粘贴 | P0 |
| M2 | JSON/JSON5 解析 | 自动识别格式，解析为内部数据结构 | P0 |
| M3 | 树形导航 | 左侧展示层级结构，支持展开/折叠 | P0 |
| M4 | 基础编辑 | 右侧表单编辑 string/number/boolean/null | P0 |
| M5 | Object 新增字段 | 输入 key + 选择类型 + 默认值 | P0 |
| M6 | Array 基础操作 | 添加/删除元素 | P0 |
| M7 | 保存文件 | 覆盖原文件或另存为 | P0 |
| M8 | JSON5 无损写回 | 保留注释、尾逗号、引号风格、缩进 | P0 |
| M9 | Key 顺序保留 | 写回时保持原有 key 顺序 | P0 |
| M10 | 差异预览 | 路径级变更列表 + 文本 diff | P0 |
| M11 | 基础校验 | 空key禁止、重复key提示 | P0 |

### 3.2 Should（应该有）

| 编号 | 功能 | 描述 | 优先级 |
|------|------|------|--------|
| S1 | Undo/Redo | 撤销/重做操作历史 | P1 |
| S2 | 自动保存 | 定时保存临时文件，崩溃恢复 | P1 |
| S3 | 版本历史 | 按文件保存多版本，可回滚 | P1 |
| S4 | Array 排序 | 上移/下移元素 | P1 |
| S5 | Mixed Array 策略 | 混合类型数组的编辑支持 | P1 |
| S6 | 导出节点片段 | 导出当前选中节点为 JSON 片段 | P1 |
| S7 | 搜索字段 | 按 key/path 搜索 | P1 |
| S8 | 扩展校验 | number 合法性、必填字段 | P1 |
| S9 | 保留未知字段 | 不破坏无法识别的字段 | P1 |

### 3.3 Could（可以有）

| 编号 | 功能 | 描述 | 优先级 |
|------|------|------|--------|
| C1 | JSON Schema 校验 | 根据 schema 验证数据 | P2 |
| C2 | 主题切换 | 明/暗主题 | P2 |
| C3 | 快捷键支持 | 常用操作快捷键 | P2 |
| C4 | 多标签页 | 同时编辑多个文件 | P2 |
| C5 | 国际化 | 多语言支持 | P2 |
| C6 | 插件系统 | 扩展功能 | P2 |

---

## 四、数据模型与写回策略

### 4.1 内部数据模型

```typescript
interface JSONNode {
  id: string;                    // 唯一标识
  type: 'object' | 'array' | 'string' | 'number' | 'boolean' | 'null';
  key?: string;                  // 字段名（object 子节点）
  index?: number;                // 索引（array 子节点）
  value: string | number | boolean | null | JSONNode[] | undefined;
  parent: JSONNode | null;       // 父节点引用
  
  // JSON5 元信息（用于无损写回）
  meta: {
    indent: string;              // 缩进字符串
    newline: '\n' | '\r\n';      // 换行符
    quote: '"' | "'";            // 引号类型
    trailingComma: boolean;      // 是否有尾逗号
    comment: {                   // 注释
      leading?: string;          // 前置注释
      trailing?: string;         // 行尾注释
      inner?: string[];          // 内部注释（多行）
    };
    rawValue?: string;           // 原始值文本（保留格式）
    unknownFields?: Map<string, string>; // 未知字段原始文本
  };
  
  order: number;                 // key 顺序索引
}

interface Document {
  filePath: string | null;
  originalContent: string;       // 原始文件内容
  root: JSONNode;                // 解析后的根节点
  isModified: boolean;
  encoding: string;
  format: 'json' | 'json5';
}
```

### 4.2 JSON5 无损写回策略

#### 核心原则

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                          JSON5 无损写回策略                                  │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                             │
│  1. 解析阶段：保留所有原始信息                                               │
│     ┌──────────────┐                                                        │
│     │ 原始 JSON5 文件 │                                                      │
│     └───────┬──────┘                                                        │
│             │ 解析器（基于 json5 库 + 自定义 AST 遍历）                        │
│             ▼                                                               │
│     ┌──────────────────────────────────────────────────────────────┐        │
│     │ 内部数据结构（JSONNode + meta）                               │        │
│     │  - 保留缩进、换行、引号风格                                    │        │
│     │  - 保留注释（前置/行尾/内部）                                  │        │
│     │  - 保留尾逗号                                                 │        │
│     │  - 保留原始值格式（数字格式、字符串转义等）                      │        │
│     └──────────────────────────────────────────────────────────────┘        │
│                                                                             │
│  2. 编辑阶段：增量更新                                                       │
│     - 修改值：更新 value，保留 meta                                          │
│     - 新增字段：继承父节点 meta 风格                                         │
│     - 删除字段：标记删除，保留位置信息用于 diff                               │
│                                                                             │
│  3. 写回阶段：智能重建                                                       │
│     - 遍历内部结构，按原始风格重建文本                                        │
│     - 新增内容使用推断的默认风格                                              │
│     - 未知字段原样输出                                                       │
│                                                                             │
└─────────────────────────────────────────────────────────────────────────────┘
```

#### 具体实现策略

| 特性 | 保留策略 | 实现方式 |
|------|----------|----------|
| **缩进** | 检测原文件缩进类型和宽度 | 解析时记录 `meta.indent`，写回时使用相同缩进 |
| **换行符** | 检测 `\n` 或 `\r\n` | 解析时记录 `meta.newline`，写回时使用相同换行符 |
| **引号风格** | 保留每个 key/value 的引号类型 | 解析时记录 `meta.quote`，写回时使用相同引号 |
| **尾逗号** | 保留原有的尾逗号 | 解析时记录 `meta.trailingComma`，写回时保持 |
| **注释** | 保留所有注释位置 | 解析时记录 `meta.comment`，写回时还原位置 |
| **Key 顺序** | 严格保持原有顺序 | 使用 `order` 字段记录位置，Map 保持插入顺序 |
| **数字格式** | 保留十六进制、科学计数法等 | 解析时记录 `meta.rawValue`，未修改时原样输出 |
| **字符串转义** | 保留原有转义方式 | 解析时记录 `meta.rawValue`，未修改时原样输出 |
| **未知字段** | 原样保留 | 存储在 `meta.unknownFields`，写回时原样输出 |

### 4.3 Mixed Array 处理策略

```typescript
type ArrayElementStrategy = 
  | 'typed'      // 同类型数组，统一编辑器
  | 'mixed'      // 混合类型，每个元素独立类型选择器
  | 'auto';      // 自动检测，根据实际内容决定

interface ArrayNode extends JSONNode {
  type: 'array';
  elementStrategy: ArrayElementStrategy;
  children: JSONNode[];
}
```

**交互设计**：
1. 解析时自动检测数组元素类型一致性
2. 同类型数组：提供统一的添加按钮，新元素继承类型
3. 混合类型数组：添加时弹出类型选择器

---

## 五、错误处理

### 5.1 错误类型与处理策略

| 错误场景 | 错误类型 | 处理策略 | 用户提示 |
|----------|----------|----------|----------|
| **解析失败** | 语法错误 | 显示错误位置和原因，提供原始文本编辑模式 | "JSON 解析失败：第 X 行，第 Y 列：预期 ':' 但发现 ','" |
| **解析失败** | 编码错误 | 尝试常见编码，提示用户选择 | "文件编码可能不是 UTF-8，请选择正确的编码" |
| **写入失败** | 权限不足 | 提示管理员权限或选择其他位置 | "没有写入权限，请以管理员身份运行或选择其他位置" |
| **写入失败** | 磁盘空间不足 | 检测空间，提前预警 | "磁盘空间不足，无法保存文件" |
| **写入失败** | 文件被占用 | 检测文件锁，提示关闭占用程序 | "文件被其他程序占用，请关闭后重试" |
| **文件锁定** | 多实例编辑同一文件 | 使用文件锁，提示用户 | "文件正在被其他实例编辑，是否以只读模式打开？" |
| **崩溃恢复** | 意外退出 | 自动加载临时文件 | "检测到未保存的编辑，是否恢复？" |
| **版本回滚** | 版本文件损坏 | 跳过损坏版本，继续显示其他版本 | "部分版本历史已损坏，已跳过" |

### 5.2 错误处理流程

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                              错误处理流程                                    │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                             │
│   操作请求                                                                   │
│      │                                                                      │
│      ▼                                                                      │
│   ┌──────────────┐                                                          │
│   │ 预检查       │◀─────────────────────────────────────────┐               │
│   └──────┬───────┘                                          │               │
│          │                                                  │               │
│     ┌────┴────┐                                             │               │
│     │ 可执行？ │                                             │               │
│     └────┬────┘                                             │               │
│       是 │   否                                             │               │
│          │    │                                             │               │
│          │    ▼                                             │               │
│          │  ┌──────────────┐                                │               │
│          │  │ 显示错误提示  │                                │               │
│          │  │ 提供解决方案  │                                │               │
│          │  └──────┬───────┘                                │               │
│          │         │                                        │               │
│          │    ┌────┴────┐                                   │               │
│          │    │ 用户选择 │                                   │               │
│          │    └────┬────┘                                   │               │
│          │         │                                        │               │
│          │    ┌────┴────┬─────────────┬────────────┐        │               │
│          │    │ 重试    │ 选择替代方案 │ 取消操作   │        │               │
│          │    └────┬────┴─────────────┴────────────┘        │               │
│          │         │                                        │               │
│          │         └────────────────────────────────────────┘               │
│          ▼                                                                  │
│   ┌──────────────┐                                                          │
│   │ 执行操作     │                                                          │
│   └──────┬───────┘                                                          │
│          │                                                                  │
│     ┌────┴────┐                                                             │
│     │ 成功？   │                                                             │
│     └────┬────┘                                                             │
│       是 │   否                                                             │
│          │    │                                                             │
│          │    ▼                                                             │
│          │  ┌──────────────┐                                                │
│          │  │ 回滚操作     │                                                │
│          │  │ 记录日志     │                                                │
│          │  │ 显示错误     │──────┐                                         │
│          │  └──────────────┘      │                                         │
│          │                        │                                         │
│          ▼                        ▼                                         │
│   ┌──────────────┐          ┌──────────────┐                                │
│   │ 更新 UI      │          │ 进入错误流程  │                                │
│   │ 记录历史     │          └──────────────┘                                │
│   └──────────────┘                                                          │
│                                                                             │
└─────────────────────────────────────────────────────────────────────────────┘
```

### 5.3 临时文件与锁文件策略

```
文件目录结构：
├── config.json5                    # 原始文件
├── .config.json5.tmp               # 临时保存文件（自动保存）
├── .config.json5.lock              # 锁文件（多实例互斥）
└── .config.json5.versions/         # 版本历史目录
    ├── 20260218_103000.json5       # 时间戳命名
    ├── 20260218_110500.json5
    └── version_index.json          # 版本索引
```

---

## 六、验收标准

### 6.1 文件操作验收标准

| 编号 | 测试项 | 前置条件 | 操作步骤 | 预期结果 | 通过标准 |
|------|--------|----------|----------|----------|----------|
| F1 | 打开 JSON 文件 | 存在有效 JSON 文件 | 文件对话框选择文件 | 正确解析并显示树形结构 | ✅ 结构完整，无报错 |
| F2 | 打开 JSON5 文件 | 存在包含注释的 JSON5 文件 | 文件对话框选择文件 | 正确解析，注释保留 | ✅ 注释在编辑后仍保留 |
| F3 | 拖拽打开文件 | 应用已启动 | 拖拽文件到窗口 | 文件正确打开 | ✅ 与对话框打开效果一致 |
| F4 | 剪贴板粘贴 | 剪贴板有有效 JSON | Ctrl+V 或菜单粘贴 | 正确解析并显示 | ✅ 可编辑和保存 |
| F5 | 保存覆盖 | 已打开并修改文件 | 点击保存 | 原文件被更新 | ✅ 内容正确，格式保留 |
| F6 | 另存为 | 已打开文件 | 文件→另存为 | 新文件创建成功 | ✅ 新文件内容正确 |
| F7 | 导出节点片段 | 选中某个节点 | 右键→导出片段 | 复制到剪贴板或保存文件 | ✅ 片段格式正确 |

### 6.2 编辑功能验收标准

| 编号 | 测试项 | 前置条件 | 操作步骤 | 预期结果 | 通过标准 |
|------|--------|----------|----------|----------|----------|
| E1 | 编辑字符串值 | 选中字符串字段 | 修改输入框内容 | 值更新，标记修改 | ✅ 值正确，diff 显示变更 |
| E2 | 编辑数字值 | 选中数字字段 | 输入有效数字 | 值更新 | ✅ 数字格式正确 |
| E3 | 编辑布尔值 | 选中布尔字段 | 切换复选框 | 值切换 | ✅ true/false 正确切换 |
| E4 | Object 新增字段 | 选中 Object 节点 | 点击添加字段，输入 key，选择类型 | 新字段添加成功 | ✅ 字段出现在末尾 |
| E5 | Object 删除字段 | 选中 Object 字段 | 右键→删除 | 字段被移除 | ✅ diff 显示删除 |
| E6 | Array 添加元素 | 选中 Array 节点 | 点击添加元素 | 新元素添加到末尾 | ✅ 元素类型正确 |
| E7 | Array 删除元素 | 选中 Array 元素 | 右键→删除 | 元素被移除 | ✅ 索引重新排列 |
| E8 | Array 上移元素 | 选中非首元素 | 点击上移 | 元素位置前移 | ✅ 顺序正确 |
| E9 | Array 下移元素 | 选中非末元素 | 点击下移 | 元素位置后移 | ✅ 顺序正确 |
| E10 | Mixed Array 编辑 | 混合类型数组 | 添加不同类型元素 | 类型选择器出现 | ✅ 可选择任意类型 |

### 6.3 JSON5 无损写回验收标准

| 编号 | 测试项 | 测试数据 | 操作 | 预期结果 | 通过标准 |
|------|--------|----------|------|----------|----------|
| P1 | 保留缩进 | 2空格缩进文件 | 打开→修改→保存 | 缩进保持2空格 | ✅ 缩进不变 |
| P2 | 保留缩进 | Tab缩进文件 | 打开→修改→保存 | 缩进保持Tab | ✅ 缩进不变 |
| P3 | 保留换行符 | CRLF 文件 | 打开→修改→保存 | 换行符保持 CRLF | ✅ 换行符不变 |
| P4 | 保留引号风格 | 单引号文件 | 打开→修改→保存 | 引号保持单引号 | ✅ 引号风格不变 |
| P5 | 保留尾逗号 | 有尾逗号文件 | 打开→修改→保存 | 尾逗号保留 | ✅ 尾逗号存在 |
| P6 | 保留注释 | 多行注释文件 | 打开→修改值→保存 | 注释保留在原位置 | ✅ 注释内容和位置不变 |
| P7 | 保留 Key 顺序 | 特定顺序 Object | 打开→修改→保存 | Key 顺序不变 | ✅ 顺序与原文件一致 |
| P8 | 保留数字格式 | 十六进制数字 | 打开→不修改→保存 | 数字格式保持 | ✅ 仍为十六进制 |
| P9 | 保留未知字段 | 包含特殊字段 | 打开→修改其他字段→保存 | 未知字段保留 | ✅ 未知字段原样存在 |

### 6.4 差异预览验收标准

| 编号 | 测试项 | 前置条件 | 操作步骤 | 预期结果 | 通过标准 |
|------|--------|----------|----------|----------|----------|
| D1 | 路径变更列表 | 已修改文件 | 点击保存 | 显示变更列表 | ✅ 所有变更路径正确列出 |
| D2 | 文本 Diff | 已修改文件 | 切换到文本 Diff 标签 | 显示文本差异 | ✅ 增删改标记正确 |
| D3 | 新增显示 | 新增字段 | 保存 | 显示新增操作 | ✅ 绿色标记，路径正确 |
| D4 | 删除显示 | 删除字段 | 保存 | 显示删除操作 | ✅ 红色标记，旧值显示 |
| D5 | 修改显示 | 修改值 | 保存 | 显示修改操作 | ✅ 黄色标记，新旧值对比 |
| D6 | 无变更提示 | 未修改文件 | 点击保存 | 提示无变更 | ✅ 显示"无变更"消息 |

### 6.5 Undo/Redo 验收标准

| 编号 | 测试项 | 前置条件 | 操作步骤 | 预期结果 | 通过标准 |
|------|--------|----------|----------|----------|----------|
| U1 | 单步撤销 | 已执行操作 | Ctrl+Z | 操作被撤销 | ✅ 恢复到操作前状态 |
| U2 | 多步撤销 | 已执行多个操作 | 多次 Ctrl+Z | 逐步撤销 | ✅ 按操作顺序撤销 |
| U3 | 撤销后重做 | 已撤销操作 | Ctrl+Y | 操作恢复 | ✅ 恢复到撤销前状态 |
| U4 | 撤销边界 | 已撤销到初始状态 | 继续撤销 | 无操作 | ✅ 提示无法撤销 |
| U5 | 新操作清空重做栈 | 已撤销后执行新操作 | 执行新操作 | 重做栈清空 | ✅ 无法重做旧操作 |

### 6.6 自动保存与崩溃恢复验收标准

| 编号 | 测试项 | 前置条件 | 操作步骤 | 预期结果 | 通过标准 |
|------|--------|----------|----------|----------|----------|
| A1 | 自动保存 | 编辑文件 | 等待自动保存间隔 | 临时文件更新 | ✅ .tmp 文件存在且内容正确 |
| A2 | 崩溃恢复 | 存在 .tmp 文件 | 重启应用 | 提示恢复 | ✅ 显示恢复对话框 |
| A3 | 恢复内容 | 选择恢复 | 点击恢复 | 内容恢复 | ✅ 编辑内容恢复 |
| A4 | 忽略恢复 | 存在 .tmp 文件 | 选择忽略 | 临时文件删除 | ✅ 打开原始文件 |

### 6.7 版本历史验收标准

| 编号 | 测试项 | 前置条件 | 操作步骤 | 预期结果 | 通过标准 |
|------|--------|----------|----------|----------|----------|
| V1 | 版本创建 | 保存文件 | 保存 | 版本记录创建 | ✅ 版本目录有新文件 |
| V2 | 版本列表 | 存在多个版本 | 打开版本历史 | 显示版本列表 | ✅ 按时间排序显示 |
| V3 | 版本预览 | 选中版本 | 点击预览 | 显示该版本内容 | ✅ 内容正确 |
| V4 | 版本回滚 | 选中版本 | 点击回滚 | 当前内容替换 | ✅ 恢复到选中版本 |
| V5 | 版本清理 | 版本超过限制 | 自动清理 | 保留最新 N 个版本 | ✅ 旧版本被删除 |

### 6.8 搜索功能验收标准

| 编号 | 测试项 | 前置条件 | 操作步骤 | 预期结果 | 通过标准 |
|------|--------|----------|----------|----------|----------|
| S1 | Key 搜索 | 文件有多个字段 | 输入搜索词 | 匹配字段高亮 | ✅ 所有匹配项显示 |
| S2 | Path 搜索 | 嵌套结构 | 输入路径模式 | 匹配路径显示 | ✅ 路径匹配正确 |
| S3 | 正则搜索 | 启用正则 | 输入正则表达式 | 正则匹配 | ✅ 正则正确执行 |
| S4 | 搜索导航 | 多个匹配结果 | 点击下一个 | 跳转到下一匹配 | ✅ 正确跳转 |

### 6.9 校验功能验收标准

| 编号 | 测试项 | 前置条件 | 操作步骤 | 预期结果 | 通过标准 |
|------|--------|----------|----------|----------|----------|
| V1 | 空 Key 检测 | Object 节点 | 输入空 key | 显示错误 | ✅ 禁止空 key |
| V2 | 重复 Key 检测 | Object 节点 | 输入已存在 key | 显示警告 | ✅ 提示重复 |
| V3 | 数字合法性 | 数字字段 | 输入非法数字 | 显示错误 | ✅ 提示格式错误 |
| V4 | 必填检测 | Schema 定义必填 | 删除必填字段 | 显示错误 | ✅ 提示必填 |

### 6.10 错误处理验收标准

| 编号 | 测试项 | 前置条件 | 操作步骤 | 预期结果 | 通过标准 |
|------|--------|----------|----------|----------|----------|
| ER1 | 解析错误处理 | 无效 JSON 文件 | 打开文件 | 显示错误位置 | ✅ 错误信息准确 |
| ER2 | 写入权限错误 | 只读目录 | 尝试保存 | 显示权限错误 | ✅ 提供解决方案 |
| ER3 | 文件占用错误 | 文件被其他程序锁定 | 尝试保存 | 显示占用提示 | ✅ 提示关闭占用程序 |
| ER4 | 多实例锁定 | 另一实例已打开文件 | 打开同一文件 | 显示锁定提示 | ✅ 提供只读选项 |

---

## 七、技术架构建议

### 7.1 技术栈推荐

| 层级 | 技术选型 | 理由 |
|------|----------|------|
| 框架 | Electron + React | 跨平台、生态成熟、开发效率高 |
| JSON5 解析 | json5 库 + 自定义 AST | 支持 JSON5 全特性 |
| 状态管理 | Zustand 或 Redux | Undo/Redo 支持 |
| UI 组件 | Ant Design 或 shadcn/ui | 成熟组件库 |
| Diff 算法 | jsondiffpatch | 结构化 diff |
| 文件监听 | chokidar | 文件变更监听 |

### 7.2 核心模块划分

```
json-editor/
├── src/
│   ├── main/                 # Electron 主进程
│   │   ├── fileSystem.ts     # 文件操作
│   │   ├── lockManager.ts    # 文件锁管理
│   │   └── autoSave.ts       # 自动保存
│   ├── renderer/             # 渲染进程
│   │   ├── components/       # UI 组件
│   │   │   ├── TreeNav/      # 树形导航
│   │   │   ├── FormEditor/   # 动态表单
│   │   │   ├── DiffPreview/  # 差异预览
│   │   │   └── VersionHistory/
│   │   ├── store/            # 状态管理
│   │   │   ├── document.ts   # 文档状态
│   │   │   ├── history.ts    # 操作历史
│   │   │   └── settings.ts   # 设置
│   │   └── utils/            # 工具函数
│   ├── core/                 # 核心逻辑
│   │   ├── parser/           # JSON/JSON5 解析
│   │   │   ├── json5.ts      # JSON5 解析器
│   │   │   └── ast.ts        # AST 处理
│   │   ├── writer/           # JSON5 写回
│   │   │   ├── serializer.ts # 序列化器
│   │   │   └── formatter.ts  # 格式化器
│   │   ├── diff/             # 差异计算
│   │   └── validation/       # 校验逻辑
│   └── types/                # 类型定义
└── tests/                    # 测试
```

---

## 八、附录

### 8.1 术语表

| 术语 | 定义 |
|------|------|
| JSON5 | JSON 的扩展格式，支持注释、尾逗号、单引号等 |
| 无损写回 | 保存时保留原文件的所有格式特性 |
| Mixed Array | 包含不同类型元素的数组 |
| 路径 | 从根节点到某字段的访问路径，如 `root.config.servers[0].host` |

### 8.2 参考资料

- [JSON5 规范](https://json5.org/)
- [JSON5 解析库](https://github.com/json5/json5)
- [jsondiffpatch](https://github.com/benjamine/jsondiffpatch)
- [Electron 文档](https://www.electronjs.org/docs)

---

## 九、版本历史

| 版本 | 日期 | 作者 | 变更说明 |
|------|------|------|----------|
| v1.0 | 2026-02-18 | - | 初始版本 |

